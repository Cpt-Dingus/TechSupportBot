language: minimal
dist: xenial

jobs:

  include:

    - stage: test
      script:
        - make dev
        - make check-format
        - make lint
        - make test

    - stage: build
      script:
        - make prod

before_deploy:
  - export TRAVIS_TAG=${TRAVIS_TAG:-${TRAVIS_BRANCH}-$(git log --format=%h -1)}
  - git tag $TRAVIS_TAG
  - cd ..
  - tar -czvf ${TRAVIS_TAG}.tar.gz ${TRAVIS_BUILD_DIR}
deploy:
  provider: releases
  token: ${GITHUB_OAUTH_TOKEN}
  edge: true

after_success:
  - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
  - chmod +x send.sh
  - ./send.sh success $WEBHOOK_URL

after_failure:
  - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
  - chmod +x send.sh
  - ./send.sh failure $WEBHOOK_URL
